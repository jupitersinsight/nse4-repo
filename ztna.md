## ZTNA

Zero-Trust Network Access is an access control method that uses client-device identification to provide authorization, authentication and role-based application access, fot both on-frabric users and off-fabric users.  

ZTNA has two modes:
- **ZTNA access proxy**: allow users to securely access resources through an SSL-encrypted access proxy. This eliminates the need of VPNs and it is aimed at remote users
- **IP/MAC-based filtering**: uses ZTNA tags for identification and enhance security for devices physically located in the corporate network. 

Both on-fabric and off-fabric endpoints are monitored using Forticlient installations. Forticlients send device status updates to a central Forticlient EMS solution which shares the tag information with the configued FortiGate. Fortigate uses ZTNA tags to enforce access control rules to incoming traffic through ZTNA access.  

Device identification is based on client certificates, while trusts relationships are built between Forticlient and Forticlient EMS, and Forticlient EMS and FortiGate.  

FortiClient collects and pass over to FortiClient EMS the device status information (OS, network details...), currently logged-in user information, and security posture (on-fabric/off-fabric, antivirus software, vulnerability status...).  

Forticlient requests and obtains a certificate from the EMS ZTNA Certificate Authority (CA) on its first attempt to connect to the access proxy. The client uses this certificate to identify itself to FortiGate.  

Forticlient EMS issues and signs the client certificate with the Forticlient UID, certificate serial number, and EMS serial number. It then synchronizes the certificate with FortiGate. FortiClient EMS also shares its EMS ZTNA CA certificate with FortiGate so it can use it to authenticate the clients.  
Forticlient EMS uses zero-trust tagging rules to tag endpoints based on the information that is has on each endpoint, these tags are also shared with FortiGate.  

FortiGate maintaines a continuous connection to FortiClient EMS to sync devices information.

FortiClient only works when connected to FortiClient EMS. Benefits are:
- remotely deploy FortiClient to Windows computers
- update profiles for endpoint users regardless of their access location
- administer FortiClient endpoint connections (accept, block, disconnect connection/session)
- manage and monitor endpoints, such as status, system, signature information
- identify outdated FortiClient software
- define web-filter rules in profiles, and remotely deploy them to FortiClient Web Filter extension on Google Chromebook endpoints

FortiClient EMS is part of the Fortinet Endpoint Security Management suite which enforce network security (supports all OSes).  

**Security Fabric**  > **Fabric Connectors** to connect FortiGate to the on-premise FortiClient EMS solutions. For the first connection, it is important to import into FortiGate the CA certificate from FortiClient EMS. The FortiGate must be authorized from FortiClient EMS GUI before they can sync data.  

Zero-Trust tagging rules are specified into EMS, then sent to FortiClients which will return data to EMS that groups devices into different groups based on tags.  


FortiClient EMS has a default **ZTNARootCA** cetificate generated by default that the ZTNA CA uses to sign CRSs (Certificate Request Signs) from the FortiClient endpoints. It is possible to force a general renew of certificates on all Fortigates and Forticlients, or to manage certificate per client or to revoke certificate used by an endpoint when certificate private keys show sign of being compromised.  

The FortiClient EMS CA certificate (ZTNA) is not the same as the SSL certificate which is by FortiClient EMS for HTTPS and fabric connectiviy to the server.  

The certificate information on clients must be the same in use on FortiGate and FortiClient EMS. On FortiGate it is possible to diagnose the presence of a matching endpoint record, and information such as the client UID, client certificate SN, and EMS certificate SN. If any of the information is missing or incomplete, client authentication might fail because FortiClient cannot locate the corresponding endpoint entry.

Endpoints obtain a client certificate when they register to FortiClient EMS. FortiClient automatically submits a CSR, FortiClient EMS signs and returns the client certificate.  
The certificate is used for all subsequent connections and it is stored in the client OS certificate store. When a client disconnets or is unregistered, the client certificate is revoked and removed from FortiClient EMS. A new certificate is issued when the client connects back to the FortiClient EMS.  

By default, client certificate authentication is enabled on the access proxy, so when FortiGate receives a connection request on HTTPS it challenges the client to identify itself with its certificate.  
If the client responds with the correct certificate: 
- if the client UID and certificate SN match the record on FortiGate, the client is allowed to continue with the ZTNA proxy rule processing
- if the client UID and certificate SN do not match the record on FortiGate, the client is blocked from further ZTNA proxy rule processing

If the client cancels and responds with an empty client certificate, the client is allowed to continue with ZTNA proxy rule processing when you can set `empty-cert-action` to `accept`. If set to `block` (default), FortiGate blocks the client. 

The FortiGate HTTPS access proxy works as a reverse proxy for the HTTP server. When a client connects to a web page hosted by the protected server, the address resolves to the FortiGate access proxy VIP. FortiGate then performs checks to determine the client identity.  

ZTNA GUI must be enabled under **Feature Visibility**.  

In order to work proprerly, ZTNA configuration on FortiGate requires:
- FortiClient EMS adds a fabric connector in the Security Fabric. FortiGate maintains a continuous connection to the EMS server to synchronize endpoint device information, and also automatically sync ZTNA tags
- the ZTNA server defines the access proxy VIP and the real servers that clients connect to. Admins can also enable authentication
- a ZTNA rule is a proxy policy used to enforce access control

Authentication to the access proxy, if enabled, supports basic HTTP and SAML methods.  
Basic HTTP authentication can reference to LDAP, RADIUS, local database or other supported authentication servers.  
A tagged group of allowed clients must be in the Source field of ZTNA access proxy rule.

**Policy & Objects** >> **ZTNA**.  
Under **ZTNA Servers**, admins configure the mapping between VIP and real server.  
Under **ZTNA rules**, admins configure access policies to ZTNA server based on tags, good clients vs bad clients, accept vs deny.  

A TCP Access Proxy allows administrators to pass TCP traffic from remote users to internal servers. The Access Proxy tunnels TCP traffic between client and FortiGate over HTTPS, and forwards the TCP traffic to the intended destination (ex, RDP/TCP to Winserver, SSH/TCP to FortiAnalyzer).

ZTNA SSH Access Proxy provides seamless SSH connection to internal server. Benefits over TCP Access Proxy:
- apply SSH deep inspection to the traffic based on the SSH related profile
- uses one time user auth to authenticate the ZTNA SSH access proxy connection, and the SSH server connection

To act as a reverse proxy, FortiGate must perform SSH host-key validation to verify the identity of the SSH server. It stores the public key of the SSH server in its SSH host-key configurations. When endpoint makes a connection to the SSH server, if the public key matches one that is used by the server, then the connection is established. If there is no match, then the connection fails.  

ZTNA IP/MAC-based enhances security when endpoint are physically located on the corporate network. It uses ZTNA tags to determine wheter traffic is allowed or denied.  

When an endpoint posture changes, the ZTNA proxy session needs to be re-verified and terminated if the endpoint is no longer compliant with the ZTNA policy.

ZTNA is session-based only and sits high in the OSI model than IP, thus it requires more headers and it is similar to SSL.
Both SSL and ZTNA are more "agile" than IPsec.

IPsec requires dedicated software or hardware to work but is it vendor-independent and uses ESP to encapsulate and encrypt network traffic.

SSL-VPNs and ZTNA are more easy to use for non-technical users, with the latter being more focused on protecting the attack surface of the internal network because zero-trust access policy applie to all, external and internal devices/users. It is even device compliant.  